name: Auto Merge Approved PR

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [synchronize]
  check_run:
    types: [completed]
  status: {}

jobs:
  auto-merge:
    # ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ¡ä»¶ã§å®Ÿè¡Œ:
    # 1. ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒsubmittedã•ã‚ŒãŸ
    # 2. PRãŒæ›´æ–°ã•ã‚ŒãŸ (synchronize)
    # 3. ãƒã‚§ãƒƒã‚¯ãƒ©ãƒ³ãŒå®Œäº†ã—ãŸ
    # 4. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ›´æ–°ã•ã‚ŒãŸ
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Claude AI App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CLAUDE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_APP_PRIVATE_KEY }}
          
      - name: Check if PR is approved and ready
        id: check-status
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            let prNumber;
            let pr;
            
            // ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ã«å¿œã˜ã¦PRç•ªå·ã‚’å–å¾—
            if (context.payload.pull_request) {
              // pull_request_review, pull_request ã‚¤ãƒ™ãƒ³ãƒˆ
              prNumber = context.payload.pull_request.number;
            } else if (context.payload.check_run && context.payload.check_run.pull_requests.length > 0) {
              // check_run ã‚¤ãƒ™ãƒ³ãƒˆ
              prNumber = context.payload.check_run.pull_requests[0].number;
            } else if (context.eventName === 'status') {
              // status ã‚¤ãƒ™ãƒ³ãƒˆ - SHAã‹ã‚‰PRã‚’æ¤œç´¢
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${context.payload.sha}`
              });
              
              if (prs.length === 0) {
                console.log('No open PRs found for this commit');
                return { shouldMerge: false };
              }
              
              prNumber = prs[0].number;
            } else {
              console.log('Could not determine PR number from event');
              return { shouldMerge: false };
            }
            
            console.log(`Processing PR #${prNumber}`);
            
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            pr = prData;
            
            // Claude AI BotãŒä½œæˆã—ãŸPRã®ã¿å¯¾è±¡
            if (pr.user.login !== 'claude-ai-assistant-for-hilltop[bot]') {
              console.log('PR not created by Claude AI Bot, skipping');
              return { shouldMerge: false };
            }
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            // æœ€æ–°ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«å–å¾—
            const latestReviews = {};
            reviews.forEach(review => {
              latestReviews[review.user.login] = review;
            });
            
            // ã‚ªãƒ¼ãƒŠãƒ¼ï¼ˆã‚ãªãŸï¼‰ã®Approvalã‚’ç¢ºèª
            const ownerReview = latestReviews['${{ github.repository_owner }}'];
            const isApproved = ownerReview && ownerReview.state === 'APPROVED';
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ç¢ºèªï¼ˆcheck runs ã¨ status checks ã®ä¸¡æ–¹ï¼‰
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            // è‡ªåˆ†è‡ªèº«ï¼ˆauto-merge workflowï¼‰ã¯é™¤å¤–
            const relevantChecks = checks.check_runs.filter(check => 
              check.name !== 'auto-merge'
            );
            
            const checksPassed = relevantChecks.length === 0 || relevantChecks.every(check => 
              check.status === 'completed' && check.conclusion === 'success'
            );
            
            const statusesPassed = statuses.state === 'success' || 
              statuses.statuses.length === 0 || 
              statuses.statuses.every(status => status.state === 'success');
            
            const allChecksPassed = checksPassed && statusesPassed;
            
            console.log(`Check runs (${relevantChecks.length}):`, relevantChecks.map(c => `${c.name}: ${c.conclusion}`));
            console.log(`Status checks (${statuses.statuses.length}):`, statuses.statuses.map(s => `${s.context}: ${s.state}`));
            console.log(`Combined status: ${statuses.state}`);
            
            console.log(`PR #${pr.number}:`);
            console.log(`- Created by: ${pr.user.login}`);
            console.log(`- Owner approved: ${isApproved}`);
            console.log(`- All checks passed: ${allChecksPassed}`);
            console.log(`- Mergeable: ${pr.mergeable}`);
            
            const shouldMerge = isApproved && allChecksPassed && pr.mergeable;
            
            return {
              shouldMerge,
              prNumber: pr.number,
              headRef: pr.head.ref,
              baseRef: pr.base.ref
            };
      
      - name: Auto merge PR
        if: fromJSON(steps.check-status.outputs.result).shouldMerge
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const result = ${{ steps.check-status.outputs.result }};
            
            try {
              // PRã‚’ãƒãƒ¼ã‚¸
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: result.prNumber,
                commit_title: `Auto-merge PR #${result.prNumber}`,
                commit_message: 'Automatically merged by GitHub Actions after approval\n\nğŸ¤– Generated with [Claude Code](https://claude.ai/code)',
                merge_method: 'squash'
              });
              
              console.log(`âœ… Successfully merged PR #${result.prNumber}`);
              
              // ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ï¼ˆå°‘ã—å¾…ã£ã¦ã‹ã‚‰ï¼‰
              await new Promise(resolve => setTimeout(resolve, 2000));
              
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${result.headRef}`
                });
                console.log(`âœ… Successfully deleted branch: ${result.headRef}`);
              } catch (deleteError) {
                console.log(`âš ï¸ Failed to delete branch: ${deleteError.message}`);
              }
              
            } catch (error) {
              console.error(`âŒ Failed to merge PR: ${error.message}`);
              throw error;
            }
      
      - name: Post merge comment
        if: fromJSON(steps.check-status.outputs.result).shouldMerge
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const result = ${{ steps.check-status.outputs.result }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: result.prNumber,
              body: 'ğŸ‰ PRãŒè‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã€ãƒ–ãƒ©ãƒ³ãƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼\n\nâœ… Approved by repository owner\nâœ… All checks passed\nâœ… Auto-merged and branch deleted\n\nğŸ¤– Automated by GitHub Actions'
            });